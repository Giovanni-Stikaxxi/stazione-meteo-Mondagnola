<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>Stazione Meteo Mondagnola</title>

<!-- ICONA APP iPHONE -->
<link rel="apple-touch-icon" href="apple-touch-icon.png">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
    body {
        background: #e8dfc8;
        font-family: Georgia, serif;
        color: #3a2f1b;
        text-align: center;
        padding: 20px;
    }

    #header {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 20px;
        margin-bottom: 20px;
    }

    #logo {
        width: 120px;
        filter: sepia(40%);
    }

    h1 {
        font-size: 36px;
        margin: 0;
        color: #4a3b24;
        text-shadow: 1px 1px 2px #c8b89a;
    }

    #indicatorsRow {
        display: flex;
        justify-content: center;
        align-items: stretch;
        gap: 10px;
        flex-wrap: nowrap;
        margin-bottom: 10px;
    }

    .indicator {
        background: #fdfaf3;
        padding: 20px;
        border: 2px solid #8b6f47;
        border-radius: 8px;
        width: 220px;
        font-size: 22px;
        box-shadow: 2px 2px 6px rgba(0,0,0,0.2);
    }

    #lastUpdateBadge {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        background: #fdfaf3;
        border: 2px solid #8b6f47;
        border-radius: 20px;
        padding: 8px 16px;
        margin-top: 5px;
        font-size: 18px;
        color: #4a3b24;
        box-shadow: 2px 2px 6px rgba(0,0,0,0.2);
    }

    .clockIcon {
        width: 22px;
        height: 22px;
        filter: sepia(60%);
    }

    button {
        background: #8b6f47;
        color: white;
        border: none;
        padding: 12px 20px;
        margin: 10px;
        font-size: 18px;
        border-radius: 6px;
        cursor: pointer;
        box-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }

    button:hover {
        background: #6e5838;
    }

    canvas {
        background: #fdfaf3;
        border: 2px solid #8b6f47;
        border-radius: 8px;
        margin-top: 20px;
        box-shadow: 3px 3px 8px rgba(0,0,0,0.25);
    }

    h2 {
        margin-top: 30px;
        color: #4a3b24;
    }

    #forecastHourly, #forecastDaily {
        display: flex;
        flex-wrap: nowrap;
        overflow-x: auto;
        gap: 10px;
        margin-top: 10px;
        padding-bottom: 5px;
    }

    .forecastCard {
        min-width: 120px;
        background: #fdfaf3;
        border: 2px solid #8b6f47;
        border-radius: 8px;
        padding: 8px;
        font-size: 14px;
        box-shadow: 2px 2px 6px rgba(0,0,0,0.2);
    }

    .forecastCard strong {
        display: block;
        margin-bottom: 4px;
    }

    .forecastIcon {
        width: 40px;
        height: 40px;
    }
</style>
</head>

<body>

<div id="header">
    <img id="logo" src="logo.png" alt="Logo">
    <h1>Stazione Meteo Mondagnola</h1>
</div>

<div id="indicatorsRow">
    <div class="indicator" id="tempBox">Temperatura: -- °C</div>
    <div class="indicator" id="humBox">Umidità: -- %</div>
</div>

<div id="lastUpdateBadge">
    <svg class="clockIcon" viewBox="0 0 24 24">
        <circle cx="12" cy="12" r="10" stroke="#8b6f47" stroke-width="2" fill="none"/>
        <line x1="12" y1="12" x2="12" y2="7" stroke="#8b6f47" stroke-width="2"/>
        <line x1="12" y1="12" x2="16" y2="12" stroke="#8b6f47" stroke-width="2"/>
    </svg>
    <span id="lastUpdateText">Ultimo rilevamento: --</span>
</div>

<h2>Andamento</h2>
<button onclick="loadData('48h')">Ultime 48 ore</button>
<button onclick="loadData('7d')">Ultima settimana</button>

<canvas id="mainChart" width="700" height="350"></canvas>

<h2>Previsioni orarie</h2>
<div id="forecastHourly"></div>

<h2>Previsioni prossimi giorni</h2>
<div id="forecastDaily"></div>

<script>
/* -------------------------
   CONFIGURAZIONE
-------------------------- */
const channelID = 3138316;
const apiKeyTS = "X07M1XRUDS5UPA6W";

// OpenWeather
const OPENWEATHER_API_KEY = "24baeac0ee482acbba73d14fe4326069";
const LAT = 44.297669;
const LON = 7.809672;

let chart;

/* -------------------------
   DATI ATTUALI THINGSPEAK
-------------------------- */
fetch(`https://api.thingspeak.com/channels/${channelID}/feeds.json?results=1&api_key=${apiKeyTS}`)
  .then(r => r.json())
  .then(data => {
      const f = data.feeds[0];

      document.getElementById("tempBox").innerHTML = "Temperatura: " + f.field1 + " °C";
      document.getElementById("humBox").innerHTML = "Umidità: " + f.field2 + " %";

      const dt = new Date(f.created_at);
      const formatted = dt.toLocaleString("it-IT", {
          day: "2-digit",
          month: "2-digit",
          year: "numeric",
          hour: "2-digit",
          minute: "2-digit"
      });

      document.getElementById("lastUpdateText").innerHTML = "Ultimo rilevamento: " + formatted;
  });

/* -------------------------
   GRAFICO THINGSPEAK
-------------------------- */
function loadData(period) {
    let url = "";

    if (period === "48h") {
        url = `https://api.thingspeak.com/channels/${channelID}/feeds.json?days=2&average=60&api_key=${apiKeyTS}`;
    } else {
        url = `https://api.thingspeak.com/channels/${channelID}/feeds.json?days=8&average=60&api_key=${apiKeyTS}`;
    }

    fetch(url)
      .then(r => r.json())
      .then(data => {
          const labels = data.feeds.map(f => f.created_at);
          const temp = data.feeds.map(f => f.field1);
          const hum = data.feeds.map(f => f.field2);

          if (chart) chart.destroy();

          chart = new Chart(document.getElementById("mainChart"), {
              type: 'line',
              data: {
                  labels: labels,
                  datasets: [
                      {
                          label: "Temperatura (°C)",
                          data: temp,
                          borderColor: "#b85c38",
                          borderWidth: 1.5,
                          tension: 0.4,
                          yAxisID: 'tempAxis'
                      },
                      {
                          label: "Umidità (%)",
                          data: hum,
                          borderColor: "#3a2f1b",
                          borderWidth: 1.5,
                          tension: 0.4,
                          yAxisID: 'humAxis'
                      }
                  ]
              },
              options: {
                  responsive: true,
                  scales: {
                      x: { display: false },
                      tempAxis: {
                          type: 'linear',
                          position: 'left',
                          title: { display: true, text: '°C' },
                          grid: { drawOnChartArea: false }
                      },
                      humAxis: {
                          type: 'linear',
                          position: 'right',
                          title: { display: true, text: '%' },
                          grid: { drawOnChartArea: false }
                      }
                  }
              }
          });
      });
}

loadData("48h");

/* -------------------------
   PREVISIONI OPENWEATHER
-------------------------- */
function loadOpenWeather() {
    const url = `https://api.openweathermap.org/data/3.0/onecall?lat=${LAT}&lon=${LON}&appid=${OPENWEATHER_API_KEY}&units=metric&lang=it`;

    fetch(url)
      .then(r => r.json())
      .then(data => {
          renderHourlyForecast(data.hourly);
          renderDailyForecast(data.daily);
      })
      .catch(err => console.error(err));
}

function renderHourlyForecast(hourly) {
    const container = document.getElementById("forecastHourly");
    container.innerHTML = "";

    hourly.slice(0, 12).forEach(h => {
        const dt = new Date(h.dt * 1000);
        const hour = dt.toLocaleTimeString("it-IT", { hour: "2-digit", minute: "2-digit" });
        const temp = Math.round(h.temp);
        const desc = h.weather[0].description;
        const icon = h.weather[0].icon;

        const card = document.createElement("div");
        card.className = "forecastCard";
        card.innerHTML = `
            <strong>${hour}</strong>
            <img class="forecastIcon" src="https://openweathermap.org/img/wn/${icon}@2x.png">
            <div>${temp} °C</div>
            <div>${desc}</div>
        `;
        container.appendChild(card);
    });
}

function renderDailyForecast(daily) {
    const container = document.getElementById("forecastDaily");
    container.innerHTML = "";

    daily.slice(1, 6).forEach(d => {
        const dt = new Date(d.dt * 1000);
        const day = dt.toLocaleDateString("it-IT", { weekday: "short", day: "2-digit", month: "2-digit" });
        const tmin = Math.round(d.temp.min);
        const tmax = Math.round(d.temp.max);
        const desc = d.weather[0].description;
        const icon = d.weather[0].icon;

        const card = document.createElement("div");
        card.className = "forecastCard";
        card.innerHTML = `
            <strong>${day}</strong>
            <img class="forecastIcon" src="https://openweathermap.org/img/wn/${icon}@2x.png">
            <div>Max: ${tmax} °C</div>
            <div>Min: ${tmin} °C</div>
            <div>${desc}</div>
        `;
        container.appendChild(card);
    });
}

loadOpenWeather();
</script>

</body>
</html>
